<html>
<head>
    <title>PZP TestPage </title>
    <link rel="stylesheet" href="../../css/index.css" type="text/css" media="screen"/>
    <link href='http://fonts.googleapis.com/css?family=Ovo' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="../../css/jquery.mobile-1.3.0.min.css" />
    <script src="../../js/jquery-1.8.2.min.js"></script>
    <script src="../../js/jquery.mobile-1.3.0.min.js"></script>
    <script type="text/javascript" src="../../webinos.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            function logMessage(msg) {
                if (msg) {
                    $('#message').append('<li>' + msg + '</li>');
                }
            }

            function printInfo(data) {
                logMessage(data.payload.message);
            }

            webinos.session.addListener('info', printInfo);

            var test = {};
            var recentService;

            $('#findService').bind('click', function () {
                test = {};
                recentService = null;
                var filter;

                var list = [];
                var connectedPzh = webinos.session.getConnectedPzh();
                for (var key in connectedPzh){
                   if (connectedPzh.hasOwnProperty(key) && connectedPzh[key] !== webinos.session.getPZHId())
                        list.push(connectedPzh[key]);
                }
                var connectedPzp = webinos.session.getConnectedPzp();

                for (var key in connectedPzp){
                    if (connectedPzp.hasOwnProperty(key) && connectedPzp[key].id !== webinos.session.getPZPId())
                        list.push(connectedPzp[key].id);
                }
                if (webinos.session.getPZHId()){
                   list.push(webinos.session.getPZHId());
                }


                list.push(webinos.session.getPZPId());

                filter ={zoneId: list, cache:false};
                // Enable this to check cache functionality = {zoneId: [webinos.session.getPZHId()], cache:false}
                var options = {timeout:12000};
                $('#get42Services').empty();
                webinos.discovery.findServices(new ServiceType('http://webinos.org/api/test'),
                        {onFound:function (service) {
                            test[service.id + service.serviceAddress] = service;
                            console.log(service);
                            $('#get42Services').append($('<option value=' + service.id + service.serviceAddress +' >' + webinos.session.getFriendlyName(service.serviceAddress)  + '</option>'));
                        }, onError: function(){
                            alert("Service is unavailable at " + JSON.stringify(filter && filter.zoneId));
                        }}, options, filter);
            });
            $('#bind').bind('click', function () {
                recentService = test[$('#get42Services option:selected').val()];
                recentService.bindService({onBind:function (service) {
                    logMessage('TEST API ' + service.api + ' bound.');
                }});
            });
            $('#get42').bind('click', function () {
                recentService.get42('foo', function (result) {
                            alert(result);
                        },
                        function (error) {
                            alert(error.code + " [" +  error.name +"]-" + error.message);
                        });
            });
            $('#listen42').bind('click', function () {
                recentService.listenerFor42(function (result) {
                    alert(result.msg);
                }, function (error) {
                    alert(error.code + " " +  error.name +" " + error.message);
                },{opts:"unused"});
            });

        });
    </script>
</head>
<body>
<table>
    <tr>
        <td>Use "Find Services" to search for available get42-Services live.<br/>
            Select one, then bind and use. Select another and bind again and use.
        </td>
    </tr>
    <tr>
        <td>
            <button id="findService" class="button">Find Services</button>
            <br/>
            <select id="get42Services"></select>
        </td>
    </tr>
    <tr>
        <td><p>
            <i> The selected address means the Service at that address
                will be used.</i>
        </p></td>
    </tr>
    <tr>
        <td>
            <button id="bind" class="button">Bind</button>
        </td>
    </tr>
    <tr>
        <td>
            <button id="get42" class="button">Get 42</button>
        </td>
    </tr>
    <tr>
        <td>
            <button id="listen42" class="button">Listener for 42</button>
        </td>
    </tr>
</table>
</body>
</html>
